# name: Deploy Portfolio to DigitalOcean

# on:
#   push:
#     branches: [ "main" ]

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       # 1️⃣ Checkout repository
#       - name: Checkout repository
#         uses: actions/checkout@v3

#       # 2️⃣ Docker login
#       - name: Docker login
#         uses: docker/login-action@v2
#         with:
#           username: ${{ secrets.DOCKERHUB_USERNAME }}
#           password: ${{ secrets.DOCKERHUB_PASSWORD }}

#       # 3️⃣ Build & push portfolio image
#       - name: Build & push portfolio image
#         run: |
#           docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/portfolio:latest .
#           docker push ${{ secrets.DOCKERHUB_USERNAME }}/portfolio:latest

#       # 4️⃣ SSH into droplet and deploy
#       - name: Deploy on DigitalOcean Droplet
#         uses: appleboy/ssh-action@v1
#         with:
#           host: ${{ secrets.DO_SSH_HOST }}
#           username: ${{ secrets.DO_SSH_USER }}
#           key: ${{ secrets.DO_SSH_PRIVATE_KEY }}
#           port: 22
#           script: |
#             # --- Stop & remove existing containers ---
#             docker stop portfolio datadog-agent || true
#             docker rm portfolio datadog-agent || true
#             docker rmi portfolio

#             # --- Start Datadog agent first ---
#             docker run -d --name datadog-agent \
#               -e DD_API_KEY="${{ secrets.DATADOG_API_KEY }}" \
#               -e DD_SITE="us5.datadoghq.com" \
#               -e DD_LOGS_ENABLED=true \
#               -v /var/run/docker.sock:/var/run/docker.sock:ro \
#               -v /var/lib/docker/containers:/var/lib/docker/containers:ro \
#               datadog/agent:latest

#             # --- Then start portfolio container ---
#             docker pull ${{ secrets.DOCKERHUB_USERNAME }}/portfolio:latest
#             docker run -d -p 80:3000 --name portfolio ${{ secrets.DOCKERHUB_USERNAME }}/portfolio:latest


name: Deploy Portfolio to DigitalOcean

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

      # 1️⃣ Checkout repository 
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Docker login
      - name: Docker login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # 3️⃣ Build & push portfolio image 
      - name: Build & push portfolio image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/portfolio:latest .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/portfolio:latest

      # 4️⃣ SSH into droplet and deploy 
      - name: Deploy on DigitalOcean Droplet
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DO_SSH_HOST }}
          username: ${{ secrets.DO_SSH_USER }}
          key: ${{ secrets.DO_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Navigate to your project directory on the Droplet.
            # IMPORTANT: Make sure this path is correct!
            cd /root/portfolio
            
            # Pull the latest changes from your repo to get the new
            # docker-compose.yml and prometheus.yml files.
            git pull origin main
            
            # Use Docker Compose to pull the new version of your app image.
            docker-compose pull app
            
            # Start all services (app, prometheus, grafana) in the background.
            # This command is smart; it will only restart the containers
            # that have changed, which in this case is just your 'app'.
            docker-compose up -d